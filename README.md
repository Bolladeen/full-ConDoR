# Full-ConDoR Pipeline

This repository contains a workflow for running the Full-ConDoR pipline using Snakemake. 

## Prerequisites

1. **Clone the repository:**
   ```bash
   git clone https://github.com/Bolladeen/full-ConDoR.git
   cd full-ConDoR
   ```

2. **To run the pipeline, create a Conda environment with the required dependencies using the command below:**
   ## Prerequisites

   - Ensure that [Mamba](https://github.com/mamba-org/mamba) and [Conda](https://docs.conda.io/projects/conda/en/latest/index.html) are installed on your system.
   - Verify that you have the necessary permissions to run shell scripts.

   Before running the script, ensure it has executable permissions. Open a terminal and navigate to the directory containing `setup_condor_env.sh`, then run:
   ```bash
   chmod +x setup_condor_env.sh
   ```
   Then, run the following command:
   ```bash
   ./setup_condor_env.sh
   ```
   Note: Ensure you obtain a Gurobi license and place it in ~/gurobi.lic or set up the $GRB_LICENSE_FILE environment variable.
   This file ensure the following dependencies are satisfied (including library version numbers if necessary):
   ### Python Libraries
   - `ete3==3.1.3`  
   - `python==3.11`  
   - `numpy`  
   - `pandas`  
   - `networkx`  
   - `snakemake<8`  
   - `biopython`  
   - `seaborn`  
   - `openpyxl`  
   - `ipykernel`  
   - `plotly`  
   - `h5py>=2.10.0`  
   - `umap-learn>=0.4.6`  
   ### Pip Dependencies

   These packages are installed using Pip :
   
   - `kaleido`  
   - `gurobipy==10.0.3`  
   - `mosaic`
     
4. **Generate Config File**

    ```yaml
    # Example configuration file
    
    # Define the working directory for output files
    workdir: /path/to/working/directory
    
    # List of patients to process
    patients:
      - patient1
      - patient2
    
    # Path to raw data directory
    raw_data_directory: /path/to/raw_data
    
    # Path to the Falcon solutions directory
    falcon_solutions: /path/to/falcon_solutions
    
    # Path to the directory with annotated mutations
    annotated_mutations: /path/to/annotated_mutations
    
    # Path to the directory with subclonal mutations (optional)
    subclonal_mutations: /path/to/subclonal_mutations
    
    # Path to the Condor pipeline scripts directory
    condor_pipeline_scripts_dir: /path/to/condor_pipeline_scripts
    
    # Path to the amplicon coordinates file
    amplicon_coordinates_file: /path/to/amplicon_coordinates.txt
    
    # Path to the downstream Condor scripts directory
    condor_downstream_scripts_dir: /path/to/condor_downstream_scripts
    
    # Path to the fast Condor script
    fast_condor_script: /path/to/fast_condor_script.py
    
    # Path to the sample name map file
    sample_name_map: /path/to/sample_name_map.txt
    
    ```
An example config file can be found at ```config_MSK_hz_local.yaml```. 

#### Parameters

- **`workdir`**: Defines the directory where all output files will be generated.

- **`patients`**: A list of patient IDs to process.

- **`raw_data_directory`**: Location of raw patient data in `.h5` format.

- **`falcon_solutions`**: Directory containing Falcon solutions such as clone assignments and profiles.

- **`annotated_mutations`**: Directory of mutation files for each patient.

- **`subclonal_mutations`**: (Optional) Directory for subclonal mutations in YAML format.

- **`condor_pipeline_scripts_dir`**: Directory containing pipeline scripts for Condor.

- **`amplicon_coordinates_file`**: File mapping gene amplicons to their coordinates.

- **`condor_downstream_scripts_dir`**: Directory for downstream Condor scripts (tree generation, etc.).

- **`fast_condor_script`**: Script to run the fast Condor pipeline.

- **`sample_name_map`**: Maps sample names to their corresponding patient IDs.

  

4. **Run Snakemake**
Navigate to the directory containing the condor_pipeline.smk file and run Snakemake using the command:
    ```bash
    snakemake -s condor_pipeline.smk
    ```

## Outputs

The following text describe the outputs of the full-ConDoR pipeline. 

### 1. `Fast-ConDoR`

- `condor_outputs/{patient}/out_tree.newick`  
  **Description:** A Newick format file containing the phylogenetic tree generated by fast-ConDoR.

- `condor_outputs/pickle_files/{patient}_self.solT_cell`  
  **Description:** A pickle file containing the serialized ETE tree data for each patient.

### 5. `Generate Solution Heatmaps`

- `condor_outputs/{patient}/heatmaps/vaf_heatmap.png`  
  **Description:** A PNG file showing the VAF heatmap for each patient.

- `condor_outputs/{patient}/heatmaps/condor_solution_heatmap.png`  
  **Description:** A PNG file with the fast-ConDoR solution heatmap for each patient.

### 6. `Generate ETE Trees`

- `condor_downstream/{patient}/{patient}_ETE_tree.refined.subclonal_snvs.png`  
  **Description:** A PNG file with the refined ETE tree showing subclonal SNVs for each patient.

- `condor_downstream/{patient}/{patient}_final_sc_clone_assignment.csv`  
  **Description:** A CSV file with the final single-cell clone assignments for each patient.

### 7. `Generate Single Cell Heatmaps`

- `post_condor_sc_heatmaps/{patient}_DNA_heatmap.pdf`  
  **Description:** A PDF file with a VAF heatmaps generated  for each patient.

### 8. `Plot CN Profiles`

- `condor_downstream/{patient}/post_condor_cn_info/{patient}.cn_clone_profiles.png`  
  **Description:** A PNG file showing the CN clone profiles for each patient.

